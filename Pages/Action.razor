@using BlazorDex.Models
@using BlazorDex.Components
@inject HeroClient client
@inject HeroStateService HeroStateService
@inject NavigationManager NavigationManager
@inject GameAnimationService AnimationService
@inject GameLogic gameLogic


<div class="h-[calc(100dvh)]  flex flex-col w-full items-center bg-center bg-cover" style="background-image: url('image/login1.png');">
    @if (gameEnd)
    {
        <div class="flex flex-col w-full min-h-[calc(100dvh)] justify-center items-center " style="background-image: url('image/login1.png');">
            <h2 class="text-5xl font-extrabold  mb-6 text-text-third">@EndGameMessage</h2>
            <button @onclick="GoHome"
                class=" bg-text-third text-white font-extrabold tracking-widest uppercase py-4 px-8 rounded-3xl shadow-xl transition transform hover:scale-110">
               Go Home
            </button>
        </div>
    }
    else
    {
        <div class="w-full flex flex-col justify-between h-full">
            <StatInAction HeroSpeed="@HeroSpeed" HeroDamage="@HeroDmg" HeroArmor="@HeroArmor" EnemySpeed="@EnemySpeed"
                EnemyDamage="@EnemyDmg" EnemyArmor="@EnemyArmor" EnemyName="@EnemyName" />
             @if(HeroStateService.Hero != null){
                        <HealthBar HeroHP="@HeroHP" HeroStartHP="@heroStartingHp" EnemyHP="@EnemyHp" EnemyStartHP="@enemyStartingHp"
                HeroLevel="@HeroStateService.Hero.Level" EnemyLevel="1" EnemyIconSrc="@IconUrl"  HeroIconSrc="image/icons/heroIcon.png"/>

             }   
    
            <Messages ActionMessages="@actionMessages" />
   
               <ActionUI isHeroTurn="@AnimationService.IsHeroTurn" isEnemyTurn="@AnimationService.IsEnemyTurn"
                EnemyIsHealing="@AnimationService.EnemyIsHealing" HeroIsHealing="@AnimationService.HeroIsHealing"
                EnemyUpgradeArmor="@AnimationService.EnemyUpgradeArmor"
                HeroUpgradeArmor="@AnimationService.HeroUpgradeArmor"
                EnemyIsGettingDmg="@AnimationService.EnemyIsGettingDmg"
                HeroIsGettingDmg="@AnimationService.HeroIsGettingDmg" HeroIsAtt="@AnimationService.HeroIsAtt"
                EnemyIsAtt="@AnimationService.EnemyIsAtt" EnemyDamageTaken="@AnimationService.GettingDamage"
                HeroDamageTaken="@AnimationService.GettingDamage" HpAdded="@AnimationService.HpAdded"
                HeavyCrash="@AnimationService.HeavyCrash" EnemyIsBessing="@AnimationService.EnemyIsBessing" 
                HeroBoosting="@AnimationService.HeroBoosting" ArmorAdded="@AnimationService.ArmorAdded" 
                ArmorReduction="@AnimationService.ArmorReduction" AttackAdded="AnimationService.AttackAdded"
                
                SceneUrl="@SceneUrl"
                AttackUrl="@AttackUrl"
                StandUrl="@StandUrl"
                DefendUrl="@DefendUrl"
                HealUrl="@HealUrl"
                BoostUrl="@BoostUrl"
            
                 />



       @if (!HasPerformed)
                        {
        <ActionButton
        Attack="() => PerformAction(HeroActionType.Attack)"
        Defend="() => PerformAction(HeroActionType.Defend)"
        Ability="() => PerformAction(HeroActionType.HeavyCrash)"
         HerTears="() => PerformAction(HeroActionType.HerTears)"
         Ability2="() => PerformAction(HeroActionType.MilkRage)"   />
                }
            else
                    {
      <ActionButton />
      }
    
        </div>
    }
</div>

@code {
[Parameter] public Func<int, int, int, Task<(int heroHp, int damageDealt)>>? EnemyAttack { get; set; }
[Parameter] public Func<int, Task<(int enemyArmor, int armorAdded)>>? EnemyUpgradeArmor { get; set; }
[Parameter] public Func<int,int, Task<(int enemyHp, int hpAdded)>>? EnemyHeal { get; set; }

/// Enemy Image
 [Parameter] public string? SceneUrl {get; set; }
 [Parameter] public string? AttackUrl {get; set; }
 [Parameter] public string? StandUrl {get; set; }
 [Parameter] public string? DefendUrl {get; set; }
 [Parameter] public string? HealUrl {get; set; }
 [Parameter] public string? BoostUrl {get; set; }
 [Parameter] public string? IconUrl {get; set; }

 /// Points and Experience
  [Parameter] public int ExperienceProvided {get; set; }
  [Parameter] public int PointsProvided {get; set; }

    /// Enemy Number of spells
    [Parameter] public int NumberOfSpells {get; set; }
    /// Hero game stats
    private int HeroDmg;
    private int HeroHP;
    private int HeroSpeed;
    private int HeroArmor;
    private bool HasPerformed = false;

    /// Initialization of the stats form the game State
    protected override async Task OnInitializedAsync()
    {
        HeroStateService.OnChange += StateHasChanged;

        if (HeroStateService.Hero != null)
        {
            heroStartingHp = HeroStateService.Hero.Hp;
            HeroDmg = HeroStateService.Hero.Dmg;
            HeroHP = HeroStateService.Hero.Hp;
            HeroSpeed = HeroStateService.Hero.Speed;
            HeroArmor = HeroStateService.Hero.Armor;
        }

        enemyStartingHp = EnemyHp;

        await DetermineTurnOrder();

    }

private async Task DetermineTurnOrder()
{
    if (HeroSpeed >= EnemySpeed)
    {   HasPerformed = false;
        AnimationService.SetTurn(true);
    }
    else
    {
        AnimationService.SetTurn(false);
        HasPerformed = true;
        await Task.Delay(2000);  // Optional: Add delay for a smoother transition

        // Trigger the enemy's attack or action immediately
        await ExecuteEnemyAction();
        
        if (!gameEnd)
        {
            AnimationService.SetTurn(true);  // Switch back to hero's turn after enemy attack
            HasPerformed = false;  // Reset to allow hero's action
        }
    }
}

 //// Hero Actions / Attack
    private async Task HeroAttack()
    {
        /// Attack Logic

        int damageDealt = Math.Max(HeroDmg - EnemyArmor, 0);
        EnemyHp -= damageDealt;
      /// Animation
        AnimationService.SetGettingDamage(false, true, damageDealt); // Enemy is getting damage
        AnimationService.SetIsAtt(true, true);
        await DisplayActionMessage("Hero attacks!");
        AnimationService.SetTurn(false);
        await AnimationService.ResetStatus();
        // Notify the UI of the change
        StateHasChanged();
         /// Game over
        if (EnemyHp <= 0)
        {
            gameEnd = true;
            EndGameMessage = "Victory!";
            await WinBattle();
        }
    }

 //// Hero Actions / Upgarde Armor
 private async Task HeroUpgradeArmor(){
        /// Upgrade Logic
         HeroArmor += 10;

        /// Animation
         AnimationService.SetUpgradeArmor(true, true, 10);
         await DisplayActionMessage("Hero defends!");
         AnimationService.SetTurn(false);
         await AnimationService.ResetStatus();
        // Notify the UI of the change
         StateHasChanged();

 }
 //// Hero Actions / Heavy Crash

  private async Task HeavyCrash(){
        if (HeroStateService.Hero == null)
        return; // Early exit if Hero is null
        /// Abilty Logic
         EnemyArmor -= HeroStateService.Hero.HeavyCrashDmg;

        /// Animation
            AnimationService.SetHeavyCrash(true, true);
            AnimationService.SetArmorReduction(true, HeroStateService.Hero.HeavyCrashDmg);
            await DisplayActionMessage("Heavy Crash!!");
            AnimationService.SetTurn(false);

            // Notify the UI of the change
            await AnimationService.ResetStatus();
  }

  private async Task TearsHealing(){
        if (HeroStateService.Hero == null)
        return; // Early exit if Hero is null
       /// Ability Logic
          HeroHP = Math.Min(HeroHP + HeroStateService.Hero.TearHealHp, heroStartingHp ?? 0);

        /// Animation
          AnimationService.SetHealing(true, true, HeroStateService.Hero.TearHealHp);
          await DisplayActionMessage("Hero heals!");
          AnimationService.SetTurn(false);

          // Notify the UI of the change
          await AnimationService.ResetStatus();

  }

  private async Task MilkRage(){
        if (HeroStateService.Hero == null)
        return; // Early exit if Hero is null
       /// Ability logic
         HeroDmg  += HeroStateService.Hero.MilkRegeStats;
         HeroArmor += HeroStateService.Hero.MilkRegeStats;
       /// Animation
            AnimationService.SetHeroBoosting(true,true, HeroStateService.Hero.MilkRegeStats, HeroStateService.Hero.MilkRegeStats);
            await DisplayActionMessage("Milk Rage!!");
            AnimationService.SetTurn(false);
            await AnimationService.ResetStatus();       

       /// Notify the UI of the change
          await AnimationService.ResetStatus();

  }

        private async Task EnemyBoost(){
        /// Ability logic
        EnemyArmor += 5;
        EnemyDmg +=10;
       /// Animation     
    
        AnimationService.SetHeroBoosting(false, true, 5, 10); /// armor , attack
        await DisplayActionMessage("Enemy is Raging!");
        EnemyDmg += 5;
        AnimationService.SetTurn(true);
        await AnimationService.ResetStatus();
        /// Notify the UI of the change
        StateHasChanged(); 


 }

    private async Task ExecuteHeroAction(HeroActionType action)
    {
        switch (action)
        {
            case HeroActionType.Attack:
                HasPerformed = true;
                await HeroAttack();
                break;
            case HeroActionType.Defend:
                HasPerformed = true;
                await HeroUpgradeArmor();
                break;
            case HeroActionType.HeavyCrash:
                HasPerformed = true;
                await HeavyCrash();
                break;
                case HeroActionType.HerTears:
                HasPerformed = true;
                await TearsHealing();

                break;
                case HeroActionType.MilkRage:
                HasPerformed = true;
                await MilkRage();
                break;
        }
    }

    private async Task PerformAction(HeroActionType action)
    {
        if (HeroStateService.Hero == null || gameEnd)
            return;

        turnCounter++;

        if (AnimationService.IsHeroTurn)
        {
            await ExecuteHeroAction(action);
            if (!gameEnd)
            {
                await ExecuteEnemyAction();
            }
        }
        else
        {
            await ExecuteEnemyAction();
            if (!gameEnd)
            {
                await ExecuteHeroAction(action);
            }
        }
    }

    private async Task ExecuteEnemyAction()
    {
        EnemyActionType enemyAction = DetermineEnemyAction();
        switch (enemyAction)
        {
            case EnemyActionType.Attack:
             if (EnemyAttack != null) 
            { 
                   var result = await EnemyAttack(HeroArmor, HeroHP, EnemyDmg);
                 HeroHP = result.heroHp;
                 /// Game over
                if (HeroHP <= 0)
            {
                 gameEnd = true;
                EndGameMessage = "Hero is defeated!";
            }
                int damageDealt = result.damageDealt;
                 /// Animation
                AnimationService.SetIsAtt(false, true);
                AnimationService.SetGettingDamage(true, true, damageDealt);
                await DisplayActionMessage($"{EnemyName} attacks!");
                AnimationService.SetTurn(true);
                await AnimationService.ResetStatus();
                StateHasChanged(); 
                await Task.Delay(2000);
                HasPerformed = false;
            }
                break;

            case EnemyActionType.Defend:
             if (EnemyUpgradeArmor != null) 
            { 
                 var ArmordResult = await EnemyUpgradeArmor(EnemyArmor);
                EnemyArmor = ArmordResult.enemyArmor;
                /// Animation
                AnimationService.SetUpgradeArmor(false, true, ArmordResult.armorAdded);
                await DisplayActionMessage($"{EnemyName} defends!");
                AnimationService.SetTurn(true);
                await AnimationService.ResetStatus();
                StateHasChanged(); 
                HasPerformed = false;
            }
                break;

            case EnemyActionType.Heal:
               if (EnemyHeal != null) 
            { 
                 var HealthResult = await EnemyHeal(EnemyHp, enemyStartingHp);
                 EnemyHp = HealthResult.enemyHp;
                   
               /// Animation
                AnimationService.SetHealing(false, true, HealthResult.hpAdded);
                await DisplayActionMessage($"{EnemyName} heals!");
                AnimationService.SetTurn(true);
                await AnimationService.ResetStatus();
                StateHasChanged(); 
                HasPerformed = false;
            }
        
                break;
            case EnemyActionType.SpecialAbilty:
                await EnemyBoost();
                HasPerformed = false;
                break;
        }
    }
/// AI
    private EnemyActionType DetermineEnemyAction()
    {
        // Basic AI to determine the enemy's action, you can expand this logic
        return (EnemyActionType)(new Random()).Next(0, NumberOfSpells); // Randomly choose an action
    }

 
    private async Task WinBattle()
    
    {   
        
        if (HeroStateService.Hero == null)
        return; // Early exit if Hero is nul
        /// calculate the experience
        int baseExperience = ExperienceProvided;
        int levelMultiplier = HeroStateService.Hero.Level > 1 ? HeroStateService.Hero.Level : 1;
        int finalExperience = baseExperience * levelMultiplier;
        HeroStateService.Hero.Exp += finalExperience;
        HeroStateService.Hero.Points += PointsProvided;


        try
        {
            await client.UpdateHero(HeroStateService.Hero);
            HeroStateService.SetHero(HeroStateService.Hero);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating Hero: {ex.Message}");
        }
    }

    private void GoHome() => NavigationManager.NavigateTo("/game");

    private void RemoveMessage(string message)
    {
        // Check if the message exists before attempting to remove it
        if (actionMessages.Contains(message))
        {
            actionMessages.Remove(message);
        }
    }

    private async Task DisplayActionMessage(string message, int delay = 2000)
    {
        actionMessages.Add(message);
        StateHasChanged();
        await Task.Delay(delay);
        actionMessages.Remove(message);
        StateHasChanged();
    }

    public int? heroStartingHp { get; set; }
    public int enemyStartingHp { get; set; }

    private enum HeroActionType
    {
        Attack,
        Defend,
        HeavyCrash,
        HerTears,
        MilkRage
    }
     private enum EnemyActionType
    {
        Attack,
        Defend,
        Heal,
        SpecialAbilty,

    }
    private bool gameEnd = false;
    private string? EndGameMessage;
     [Parameter] public int EnemyHp {set; get;}
     [Parameter] public int EnemySpeed {set; get;}
     [Parameter] public int EnemyArmor {set; get;}
     [Parameter] public int EnemyDmg  {set; get;}
    [Parameter] public string? EnemyName { get; set; }

    private int turnCounter = 0;
    private List<string> actionMessages = new List<string>();
   
}